<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Girl Math Verdict ✨</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-N4f7z2E1UPZZO3yTSXL4j7uFiR8qU5y4lTaLH3kfgvO5U6n3q7X9Yv1+9K7K3+5v8Y7lGHFqMWiT9O7Obx4X+g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <!-- Video Background -->
    <div class="video-background" aria-hidden="true">
        <video autoplay muted loop playsinline>
            <source src="/public/videos/hero-background.mp4" type="video/mp4">
        </video>
        <div class="bg-radial-vignette"></div>
    </div>
    <!-- Hidden ShareableCard for image generation -->
    <div id="shareableCard" class="shareable-card" style="display: none;">
        <div class="shareable-card-content">
            <div class="shareable-header">CERTIFIED GIRL MATH</div>
            <div class="shareable-item-box">
                <div class="shareable-category" id="shareableCategory">CLOTHING</div>
                <div class="shareable-price" id="shareablePrice"></div>
            </div>
            <div class="shareable-stamp-container">
                <div class="shareable-stamp" id="shareableStamp"></div>
            </div>
            <div class="shareable-metrics-box">
                <div class="shareable-metric">
                    <span class="shareable-metric-label">COST PER USE</span>
                    <span class="shareable-cost-per-use" id="shareableCostPerUse"></span>
                </div>
                <div class="shareable-metric">
                    <span class="shareable-metric-label">GIRL MATH SCORE</span>
                    <span class="shareable-score" id="shareableScore"></span>
                </div>
            </div>
            <div class="shareable-punchline" id="shareablePunchline"></div>
            <div class="shareable-footer">
                <div class="shareable-url">girlmath.app</div>
                <div class="shareable-tag">#GIRLMATH</div>
            </div>
        </div>
    </div>
    <div class="container verdict-container">
        <header>
            <h1 class="title"><span class="sparkle-v" aria-hidden="true">✨</span>Girl Math Verdict <span class="sparkle">✨</span></h1>
            <p class="subtitle">Your purchase justification</p>
            <nav class="tabs-nav" style="margin-top: 15px;">
                <a href="index.html" class="tab-link">Scanner</a>
                <a href="calculator.html" class="tab-link active">Calculator</a>
            </nav>
        </header>
        <div class="verdict-card" id="verdictCard">
            <div class="card-header">
                <div class="context-pills" id="contextPills">
                    <!-- Generated dynamically -->
                </div>
                <h2>GIRL MATH VERDICT</h2>
            </div>
            
            <div class="stamp-container">
                <div class="stamp" id="stamp">APPROVED ✅</div>
            </div>

            <div class="confidence-meter" id="confidenceMeter">
                <!-- Generated dynamically -->
            </div>

            <div class="what-if-section" id="whatIfSection" style="display: none;">
                <!-- Generated dynamically -->
            </div>

            <div class="community-insights-container" id="communityInsights">
                <!-- Generated dynamically -->
            </div>

            <div class="metrics" id="metrics">
                <!-- Generated dynamically -->
            </div>

            <div class="punchline" id="punchline">
                <!-- Generated dynamically -->
            </div>
        </div>

        <div class="actions">
            <button onclick="copyLink()" class="action-btn secondary">Share Result</button>
            <a href="calculator.html" class="action-btn secondary">Start Over</a>
        </div>
        <footer class="footer">
            Built as a lightweight consumer decision tool. Not financial advice.
        </footer>
    </div>
    <script src="app.js"></script>
    <script>
        // Load verdict from URL params or sessionStorage
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            let data = null;
            
            // Support both formats: individual parameters (new) or data parameter (old)
            if (params.has('price') || params.has('data')) {
                // New format: individual parameters
                if (params.has('price')) {
                    // Validate and sanitize URL parameters (using same validation as app.js)
                    const ALLOWED_INCOME_RANGES = ['under30', '30to60', '60to100', '100to200', 'over200'];
                    const ALLOWED_BUDGET_PERCENTS = ['5', '10', '15', '20', '25'];
                    const allowedCategories = ['clothes', 'skincare', 'food', 'subscription', 'gift', 'jewellery', 'other'];
                    
                    const rawData = {
                        price: params.get('price'),
                        category: params.get('category') || '',
                        uses: params.get('uses') || '',
                        originalPrice: params.get('originalPrice') || params.get('listPrice') || '',
                        discountPercent: params.get('discountPercent') || '',
                        income: params.get('income') || '',
                        budgetPercent: params.get('budgetPercent') || ''
                    };
                    
                    // Validate all parameters
                    data = {};
                    
                    const price = parseFloat(rawData.price);
                    if (!isNaN(price) && price > 0 && price <= 1000000) {
                        data.price = price.toString();
                    }
                    
                    if (rawData.category && allowedCategories.includes(rawData.category)) {
                        data.category = rawData.category;
                    }
                    
                    const uses = parseInt(rawData.uses);
                    if (!isNaN(uses) && uses > 0 && uses <= 10000) {
                        data.uses = uses.toString();
                    }
                    
                    const originalPrice = parseFloat(rawData.originalPrice);
                    if (!isNaN(originalPrice) && originalPrice > 0 && originalPrice <= 1000000) {
                        data.originalPrice = originalPrice.toString();
                    }
                    
                    if (rawData.income && ALLOWED_INCOME_RANGES.includes(rawData.income)) {
                        data.income = rawData.income;
                    }
                    
                    if (rawData.budgetPercent && ALLOWED_BUDGET_PERCENTS.includes(rawData.budgetPercent)) {
                        data.budgetPercent = rawData.budgetPercent;
                    }
                    
                    const discountPercent = parseFloat(rawData.discountPercent);
                    if (!isNaN(discountPercent) && discountPercent >= 0 && discountPercent <= 100) {
                        data.discountPercent = discountPercent.toString();
                    }
                } 
                // Old format: data parameter (JSON)
                else if (params.has('data')) {
                    try {
                        data = JSON.parse(decodeURIComponent(params.get('data')));
                        if (data.listPrice && !data.originalPrice) {
                            data.originalPrice = data.listPrice;
                        }
                    } catch (e) {
                        console.error('Error parsing URL data:', e);
                    }
                }
            } else {
                // Fallback to sessionStorage
                const storedData = sessionStorage.getItem('girlMathData');
                if (storedData) {
                    try {
                        data = JSON.parse(storedData);
                    } catch (e) {
                        console.error('Error parsing stored data:', e);
                    }
                }
            }
            
            if (data) {
                generateVerdict(data);
            } else {
                // Redirect to calculator if no data
                window.location.href = 'calculator.html';
            }
        });
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
